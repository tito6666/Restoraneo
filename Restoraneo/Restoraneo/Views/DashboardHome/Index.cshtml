@model Restoraneo.ViewModels.RestaurantDashboardViewModel

<link href="~/Content/PagedList.css" rel="stylesheet" type="text/css" />
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
    var reservationStatus = "";
    var reservationStatusTextClass = "";
   int i = 0;
   var rowNumber = 0;
}

<div class="alert alert-info" style="height:200px;margin-left: 15px; margin-top: 5px; width:100%">
	<div class="row tile_count">
		<div class="col-md-2 col-sm-4 col-xs-6 tile_stats_count">
			<span class="count_top"><i class="fa fa-cutlery"></i> Broj rezervacija</span>
			<div id="numOfReservations" class="count">@Model.DashboardStats.NumOfReservations</div>
		</div>
		<div class="col-md-2 col-sm-4 col-xs-6 tile_stats_count">
			<span class="count_top"><i class="glyphicon glyphicon-registration-mark"></i> Iskorištene rezervacije</span>
			<div id="numOfUsedReservations" class="count">@Model.DashboardStats.NumOfUsedReservations</div>
		</div>
		<div class="col-md-2 col-sm-4 col-xs-6 tile_stats_count">
			<span class="count_top" style="margin-right: 5px;"><i class="fa fa-calendar-check-o"></i> Potvrđene rezervacije</span>
			<div id="numOfConfirmedReservations" class="count green">@Model.DashboardStats.NumOfConfirmedReservations</div>
		</div>
		<div class="col-md-2 col-sm-4 col-xs-6 tile_stats_count">
			<span class="count_top"><i class="fa fa-calendar-times-o"></i> Otkazane rezervacije</span>
			<div id="numOfCanceledReservations" class="count">@Model.DashboardStats.NumOfCanceledReservations</div>
		</div>
		<div class="col-md-2 col-sm-4 col-xs-6 tile_stats_count">
			<span class="count_top"><i class="fa fa-users"></i> Broj korisnika</span>
			<div id="numOfUsers" class="count">@Model.DashboardStats.NumOfUsers</div>
		</div>
		<div class="col-md-2 col-sm-4 col-xs-6 tile_stats_count">
			<span class="count_top"><i class="fa fa-user"></i> Broj rezerviranih mjesta</span>
			<div id="numOfReservaitedSeats" class="count">@Model.DashboardStats.NumOfReservaitedSeats</div>
		</div>
	</div>
	<div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc;">
		<i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
		<span></span> <b class="caret"></b>
	</div>

</div>

@Html.Partial("_DashboardReservationsPreview", @Model.Reservations);

@section scripts 
{
<!--Reference the autogenerated SignalR hub script. -->
<script src="signalr/hubs"></script>
<!--Add script to update the page and send messages.-->
<script type="text/javascript">
    $(function () {
    // Declare a proxy to reference the hub.
    var reservation = $.connection.reservationHub;
    // Create a function that the hub can call to broadcast messages.
    reservation.client.addClientReservation = function (viewModel) {								
				var data = {
						RestaurantId: viewModel.RestaurantId,
						NumberOfPersons: viewModel.NumberOfPersons,
						DateOfReservation: viewModel.DateOfReservation,
						TimeOfReservation: viewModel.TimeOfReservation,
						UserId: viewModel.ClientId
					};
        bootbox.dialog({
            message: 'Rezervacija za ' + viewModel.NumberOfPersons + ' osobe ' +
                 'u ' + viewModel.TimeOfReservation + ' sati' + ' na datum ' + moment(viewModel.DateOfReservation).format('DD.MM.YYYY') + '?',
            title: "Potvrda rezervacije",
            buttons: {
                no: {
                    label: "Ne",
                    className: "btn-default",
                    callback: function () {
                        bootbox.hideAll();
                        reservation.server.sendResponseToClient(viewModel, "Vaša rezervacija je odbijena!");
                    }
                },
                yes: {
                    label: "Da",
                    className: "btn-success",
                    callback: function () {
                        $.ajax({
                            type: 'POST',
                            url: '/api/ReservationsApi',
                            data: data
                        }).done(function (data) {
                            reservation.server.sendResponseToClient(viewModel, "Vaša rezervacija je uspješno zaprimljena!");
							getDashboardStatsByDateRange();							
                        }).fail(function (data) {
                            alert("Nešto nije u redu!")
                        });
                    }
                }
            }
        });
    };

    // Start the connection.
    $.connection.hub.start().done(function () {
    });
});
</script>
    <script>
$(function() {
	moment.locale('hr');
    var start = moment().subtract(29, 'days');
    var end = moment();

    function cb(start, end) {
        $('#reportrange span').html(start.format('D.M.YYYY.') + ' - ' + end.format('D.M.YYYY.'));
    }

    $('#reportrange').daterangepicker({
        startDate: start,
        endDate: end,
		locale: {			
            format: 'D.M.YYYY.',
			applyLabel: 'Potvrdi',
			cancelLabel: 'Otkaži',
        }		
    }, cb);

    cb(start, end);

});
        $(document).ready(function () {
		
		$('.applyBtn').click(function(){
		getDashboardStatsByDateRange();
		});
			
            $(".js-btn-reservationStatus").click(function (e) {
                var button = $(e.target);
                bootbox.dialog({
                    message: 'Jeste li sigurni da želite promijeniti status rezervacije iz ' +
                        '<b>"' + $('p#' + button.attr('id')).text() +
                        '"</b>' + ' u ' + '<b>"' + button.text() + '"</b> ?',
                    title: "Promjena statusa rezervacije",
                    buttons: {
                        no: {
                            label: "Ne",
                            className: "btn-default",
                            callback: function () {
                                bootbox.hideAll();
                            }
                        },
                        yes: {
                            label: "Da",
                            className: "btn-success",
                            callback: function () {
                                var btnClass = "";
                                var btnText = "";
                                if (button.hasClass("btn-success")) {
                                    btnClass = "text-success";
                                    btnText = "Potvrđena";
                                }
                                else if (button.hasClass("btn-danger")) {
                                    btnClass = "text-danger";
                                    btnText = "Otkazana";
                                }
                                else {
                                    btnClass = "";
                                    btnText = "Iskorištena";
                                }
                                $.post("/api/reservationstatus", {
                                    id: button.attr("id"),
                                    statusId: button.attr("data-reservationStatusId")
                                })
                                   .done(function () {
                                       $("p#" + button.attr("id"))
                                            .removeClass($("p#" + button.attr("id")).attr("class"))
                                            .addClass(btnClass)
                                            .text(btnText)
											getDashboardStatsByDateRange();
                                   })
                                   .fail(function () {
                                       alert("Nešto nije u redu!")
                                   })
                            }
                        }
                    }
                });
            })
        })
		
		function getDashboardStatsByDateRange()
		{
		var stDate = $('#reportrange').data('daterangepicker').startDate.format('D.M.YYYY.');
		var enDate = $('#reportrange').data('daterangepicker').endDate.format('D.M.YYYY.');

		 $.get("/api/dashboardapi", {stDate : stDate, enDate : enDate, restId : '@Model.RestaurantId'})
                                   .done(function (model) {
                                      $('#numOfReservations').html(model.NumOfReservations)
									  $('#numOfUsedReservations').html(model.NumOfUsedReservations)
									  $('#numOfConfirmedReservations').html(model.NumOfConfirmedReservations)
									  $('#numOfCanceledReservations').html(model.NumOfCanceledReservations)
									  $('#numOfUsers').html(model.NumOfUsers)
									  $('#numOfReservaitedSeats').html(model.NumOfReservaitedSeats)
                                   })
                                   .fail(function () {
                                       alert("Nešto nije u redu!")
                                   })
		}
</script>

}
